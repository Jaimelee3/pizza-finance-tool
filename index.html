<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üçï AI Pizza Finance Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background:#f8f8f8; margin:0; padding:20px; }
    .container { max-width: 760px; margin:auto; background:#fff; padding:22px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.08); }
    h1 { text-align:center; color:#c85151; margin-top:4px; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, select, button { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #ccc; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    button { background:#c85151; color:#fff; font-weight:700; cursor:pointer; border:none; margin-top:14px; }
    button:hover { filter:brightness(.95); }
    .result { margin-top:18px; background:#111; color:#eee; padding:14px; border-radius:8px; white-space:pre-wrap; }
    table { border-collapse:collapse; width:100%; margin-top:12px; }
    th, td { border:1px solid #ddd; padding:8px; text-align:left; }
    th { background:#efefef; }
    .muted { color:#666; font-size:13px; margin-top:10px; }
    .warn { background:#fff7e6; border:1px solid #ffd27b; color:#7a5200; padding:10px 12px; border-radius:8px; margin-top:12px; }
    .toggle { display:flex; align-items:center; gap:8px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üçï AI Pizza Finance Tool</h1>

    <div class="row">
      <div>
        <label>Investment Amount ($):</label>
        <input id="amount" type="number" placeholder="e.g., 5000" min="1" />
      </div>
      <div>
        <label>Risk Preference:</label>
        <select id="risk">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>
    </div>

    <label>Your OpenAI API Key (starts with sk-):</label>
    <input id="apikey" type="password" placeholder="Paste your key (or use Demo Mode)" />

    <div class="toggle">
      <input type="checkbox" id="demoMode">
      <label for="demoMode">Demo Mode (no API)</label>
    </div>

    <button id="go">Get Portfolio</button>

    <div id="advice" class="warn" style="display:none;"></div>
    <div id="pretty"></div>
    <div id="output" class="result">Waiting‚Ä¶</div>

    <p class="muted">‚ö†Ô∏è Disclaimer: Educational/demo only. Not financial advice. Uses pizza analogies to explain risk. Don‚Äôt bet rent on pineapple.</p>
  </div>

<script>
async function getBTCPrice() {
  try {
    const r = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd");
    const j = await r.json(); return j?.bitcoin?.usd ?? "N/A";
  } catch { return "N/A"; }
}

function mockPortfolio(btc) {
  return {
    safe_pizza: { pepperoni: "30% (stocks)", cheese: "40% (bonds)", crust: "30% (savings)" },
    spicy_pizza:{ pepperoni: "60% (stocks)", pineapple: "30% (crypto, BTC ~ $" + btc + ")", crust: "10% (savings)" },
    explanation: "Pepperoni = growth but volatile; cheese stabilizes; pineapple is crypto spice."
  };
}

function renderTable(json) {
  if (!json) return "";
  const rows = (o)=>Object.entries(o).map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("");
  return `
    <h3>Safe Pizza üçï</h3>
    <table><tr><th>Topping</th><th>Allocation</th></tr>${rows(json.safe_pizza||{})}</table>
    <h3>Spicy Pizza üå∂Ô∏èüçï</h3>
    <table><tr><th>Topping</th><th>Allocation</th></tr>${rows(json.spicy_pizza||{})}</table>
    ${json.explanation ? `<p><em>${json.explanation}</em></p>` : ""}
  `;
}

function showAdvice(msg){ const el=document.getElementById("advice"); el.textContent=msg; el.style.display="block"; }
function hideAdvice(){ const el=document.getElementById("advice"); el.style.display="none"; }

document.getElementById("go").addEventListener("click", async () => {
  hideAdvice();
  const amount = document.getElementById("amount").value.trim();
  const risk   = document.getElementById("risk").value;
  const key    = document.getElementById("apikey").value.trim();
  const demo   = document.getElementById("demoMode").checked;
  const output = document.getElementById("output");
  const pretty = document.getElementById("pretty");
  pretty.innerHTML = "";
  output.textContent = "üçï Thinking...";

  if (!amount || Number(amount) <= 0) { output.textContent = "‚ùå Enter a positive amount."; return; }

  const btc = await getBTCPrice();

  if (demo) {
    const mock = mockPortfolio(btc);
    pretty.innerHTML = renderTable(mock);
    output.textContent = JSON.stringify(mock, null, 2);
    showAdvice("Demo Mode is ON (no API used). Enable billing to use real AI.");
    return;
  }

  if (!key || !key.startsWith("sk-")) {
    const mock = mockPortfolio(btc);
    pretty.innerHTML = renderTable(mock);
    output.textContent = JSON.stringify(mock, null, 2);
    showAdvice("No API key provided. Showing Demo Mode output.");
    return;
  }

  const prompt = `
You are a funny but smart financial advisor who only explains investments using pizza toppings.
User has $${amount} and risk preference "${risk}".
Create two scenarios: Safe Pizza (conservative) and Spicy Pizza (higher risk).
Toppings: Pepperoni=Stocks, Cheese=Bonds, Pineapple=Crypto, Crust=Savings.
Rules:
- Output STRICT JSON only (no prose, no backticks)
- Keys: safe_pizza, spicy_pizza, explanation
- Allocation values are percentages with labels
- Mention live Bitcoin price = $${btc}
`.trim();

  try {
    const resp = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: { "Content-Type":"application/json", "Authorization":`Bearer ${key}` },
      body: JSON.stringify({ model:"gpt-4o-mini", messages:[{role:"user", content:prompt}], temperature:0.7 })
    });

    const raw = await resp.json();

    // Handle OpenAI errors gracefully
    if (!resp.ok) {
